{
  "path": "/docs/resource-handling-and-service-workers/",
  "result": {
    "data": {
      "mdx": {
        "body": "function _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"title\": \"Resource Handling & Service Workers\"\n};\n\nvar makeShortcode = function makeShortcode(name) {\n  return function MDXDefaultShortcode(props) {\n    console.warn(\"Component \" + name + \" was not imported, exported, or provided by MDXProvider as global scope\");\n    return mdx(\"div\", props);\n  };\n};\n\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, [\"components\"]);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, \"This document aims to outline how resources are fetched and cached by various parts of Gatsby.\"), mdx(\"h2\", {\n    \"id\": \"offline-plugin-gatsby-plugin-offline\"\n  }, mdx(\"a\", _extends({\n    parentName: \"h2\"\n  }, {\n    \"href\": \"#offline-plugin-gatsby-plugin-offline\",\n    \"aria-label\": \"offline plugin gatsby plugin offline permalink\",\n    \"className\": \"anchor\"\n  }), mdx(\"svg\", _extends({\n    parentName: \"a\"\n  }, {\n    \"aria-hidden\": \"true\",\n    \"focusable\": \"false\",\n    \"height\": \"16\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"16\"\n  }), mdx(\"path\", _extends({\n    parentName: \"svg\"\n  }, {\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  })))), \"Offline Plugin (gatsby-plugin-offline)\"), mdx(\"h3\", {\n    \"id\": \"service-worker-swjs\"\n  }, mdx(\"a\", _extends({\n    parentName: \"h3\"\n  }, {\n    \"href\": \"#service-worker-swjs\",\n    \"aria-label\": \"service worker swjs permalink\",\n    \"className\": \"anchor\"\n  }), mdx(\"svg\", _extends({\n    parentName: \"a\"\n  }, {\n    \"aria-hidden\": \"true\",\n    \"focusable\": \"false\",\n    \"height\": \"16\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"16\"\n  }), mdx(\"path\", _extends({\n    parentName: \"svg\"\n  }, {\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  })))), \"Service worker (\", mdx(\"inlineCode\", {\n    parentName: \"h3\"\n  }, \"sw.js\"), \")\"), mdx(\"p\", null, \"In the offline plugin, we specify which types of files should be automatically cached at runtime (i.e. resource files) so that whenever these are fetched from the network, they are saved in the cache.\"), mdx(\"p\", null, \"We also keep an array stored in the IndexedDB which keeps a list of page paths (e.g. \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"/about/\"), \") whose resources have all been cached. For these paths, we serve the offline shell rather than the full HTML, because we know that their resources are readily available (even if offline). For paths which aren\\u2019t in this array, we load the HTML from the server as usual, which allows for native offline error pages to be displayed if the network is offline and allows static HTML to be rendered if the JS resources fail for some reason (e.g. due to an adblocker false-positive).\"), mdx(\"p\", null, \"It\\u2019s important that this array is accurate - if a page entered the array when its resources hadn\\u2019t actually been cached, then the page could appear blank when loaded if the site updated in the meantime. A problem with the current approach is that devices may automatically remove cached files if they\\u2019re running out of space, while the IDB array would still report these pages as being cached - in the future we aim to handle this behavior.\"), mdx(\"h3\", {\n    \"id\": \"browser-apis-gatsby-browserjs\"\n  }, mdx(\"a\", _extends({\n    parentName: \"h3\"\n  }, {\n    \"href\": \"#browser-apis-gatsby-browserjs\",\n    \"aria-label\": \"browser apis gatsby browserjs permalink\",\n    \"className\": \"anchor\"\n  }), mdx(\"svg\", _extends({\n    parentName: \"a\"\n  }, {\n    \"aria-hidden\": \"true\",\n    \"focusable\": \"false\",\n    \"height\": \"16\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"16\"\n  }), mdx(\"path\", _extends({\n    parentName: \"svg\"\n  }, {\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  })))), \"Browser APIs (\", mdx(\"inlineCode\", {\n    parentName: \"h3\"\n  }, \"gatsby-browser.js\"), \")\"), mdx(\"p\", null, \"When all resources for a page have been successfully prefetched, we do \", mdx(\"em\", {\n    parentName: \"p\"\n  }, \"one\"), \" of the following:\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Add the page\\u2019s path to a temporary array of prefetched paths, if the service worker has not yet installed\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Send a message to the service worker to let it know to whitelist the page\\u2019s path, if it is installed\")), mdx(\"p\", null, \"Upon initial install, we do the following:\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Loop through all scripts and stylesheets in the head and fetch these again, so that Workbox can now cache them\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Fetch all resources for pages whose paths are in the temporary prefetched paths array, so that Workbox can now cache them\")), mdx(\"p\", null, \"Note that in both of the above cases, all these files should have already been downloaded once by the browser, so with \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"/docs/caching/\"\n  }), \"proper HTTP caching setup\"), \" we don\\u2019t have to download any of the files again. However, one exception to this is \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"<style>\"), \" elements with a \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"data-href\"), \" attribute (indicating that the embedded stylesheet is the same as the stylesheet at the location specified) - we currently fetch the specified file rather than caching the contents of the element.\"), mdx(\"p\", null, \"Another current problem is that we may start fetching the resources for a page before the service worker has finished installing, but finish fetching them all after it has installed - this could cause a page\\u2019s path to be whitelisted even if some of its resources haven\\u2019t been cached (since Gatsby assumes the service worker was installed at the start of fetching resources, if it was installed at the end).\"), mdx(\"h2\", {\n    \"id\": \"gatsby-core\"\n  }, mdx(\"a\", _extends({\n    parentName: \"h2\"\n  }, {\n    \"href\": \"#gatsby-core\",\n    \"aria-label\": \"gatsby core permalink\",\n    \"className\": \"anchor\"\n  }), mdx(\"svg\", _extends({\n    parentName: \"a\"\n  }, {\n    \"aria-hidden\": \"true\",\n    \"focusable\": \"false\",\n    \"height\": \"16\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"16\"\n  }), mdx(\"path\", _extends({\n    parentName: \"svg\"\n  }, {\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  })))), \"Gatsby Core\"), mdx(\"h3\", {\n    \"id\": \"resource-loader-loaderjs\"\n  }, mdx(\"a\", _extends({\n    parentName: \"h3\"\n  }, {\n    \"href\": \"#resource-loader-loaderjs\",\n    \"aria-label\": \"resource loader loaderjs permalink\",\n    \"className\": \"anchor\"\n  }), mdx(\"svg\", _extends({\n    parentName: \"a\"\n  }, {\n    \"aria-hidden\": \"true\",\n    \"focusable\": \"false\",\n    \"height\": \"16\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"16\"\n  }), mdx(\"path\", _extends({\n    parentName: \"svg\"\n  }, {\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  })))), \"Resource loader (\", mdx(\"inlineCode\", {\n    parentName: \"h3\"\n  }, \"loader.js\"), \")\"), mdx(\"p\", null, \"There are two functions which perform a similar but distinct role in this file: \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"enqueue\"), \" and \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"getResourcesForPathname\"), \". The former of these, \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"enqueue\"), \", is designed to speed up navigation by prefetching resources for a page, before we need to display the page, and hence it doesn\\u2019t return anything. On the other hand, \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"getResourcesForPathname\"), \" is used when we need the resources right now, usually in order to display the page, and therefore it fetches with higher priority than \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"enqueue\"), \" as well as returning them. Another difference between the two is that \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"getResourcesForPathname\"), \" returns the resources for the 404 page if the specified page doesn\\u2019t exist.\"), mdx(\"p\", null, \"In the future, we could refactor these into a single function which takes parameters for whether or not to return the 404 page if the specified page is missing, and for whether to fetch with high or low priority.\"), mdx(\"h3\", {\n    \"id\": \"ensureresources-ensure-resourcesjs\"\n  }, mdx(\"a\", _extends({\n    parentName: \"h3\"\n  }, {\n    \"href\": \"#ensureresources-ensure-resourcesjs\",\n    \"aria-label\": \"ensureresources ensure resourcesjs permalink\",\n    \"className\": \"anchor\"\n  }), mdx(\"svg\", _extends({\n    parentName: \"a\"\n  }, {\n    \"aria-hidden\": \"true\",\n    \"focusable\": \"false\",\n    \"height\": \"16\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"16\"\n  }), mdx(\"path\", _extends({\n    parentName: \"svg\"\n  }, {\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  })))), \"EnsureResources (\", mdx(\"inlineCode\", {\n    parentName: \"h3\"\n  }, \"ensure-resources.js\"), \")\"), mdx(\"p\", null, \"The \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"EnsureResources\"), \" component exists to (as its name suggest) ensure that we have the resources for a specified page, and load them if we currently don\\u2019t. There are some valid reasons why we might not have resources at the time of navigation:\"), mdx(\"ol\", null, mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"404s resulting from site-internal links, when the user has not created a custom 404 page with \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"404.js\")), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"When visiting a page (which hasn\\u2019t been visited before), the site may have been updated since our last navigation and so the resources to the unvisited page may have changed location\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Ad blockers may block access to certain paths in which case we\\u2019re unable to load the JS resources for a page\")), mdx(\"p\", null, \"Here is how the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"EnsureResources\"), \" component handles each of these scenarios:\"), mdx(\"ol\", null, mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"On non-initial renders, reload upon missing resources so that the browser can load the server\\u2019s 404 page\")), mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"On initial renders, flag the page as failed and throw an error to prevent rendering a blank page (static HTML will suffice), then reload it once the service worker updates\"), mdx(\"p\", {\n    parentName: \"li\"\n  }, \"On non-initial renders, reload upon missing resources so that the browser can load the latest page\")), mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"p\", {\n    parentName: \"li\"\n  }, \"On initial renders, throw an error to prevent rendering a blank page (static HTML will suffice)\"))), mdx(\"p\", null, \"The following are some invalid reasons why we might not have resources, i.e. things which we should never have to worry about:\"), mdx(\"ol\", null, mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"404s from external links, without a custom 404 page - the page will load from the server in the first place, so Gatsby won\\u2019t even kick in at this point\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"404s, with a custom 404 page - \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"getResourcesForPathname\"), \" will automatically return the resources for the custom 404 page\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Visiting a previously-visited page via an external link, when the site\\u2019s resources have since updated - previously-visited pages are cached, so they\\u2019ll work even if the site has updated since. Unvisited pages will always load from the server and get the latest resources.\")), mdx(\"h3\", {\n    \"id\": \"service-worker-update-handling\"\n  }, mdx(\"a\", _extends({\n    parentName: \"h3\"\n  }, {\n    \"href\": \"#service-worker-update-handling\",\n    \"aria-label\": \"service worker update handling permalink\",\n    \"className\": \"anchor\"\n  }), mdx(\"svg\", _extends({\n    parentName: \"a\"\n  }, {\n    \"aria-hidden\": \"true\",\n    \"focusable\": \"false\",\n    \"height\": \"16\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"16\"\n  }), mdx(\"path\", _extends({\n    parentName: \"svg\"\n  }, {\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  })))), \"Service worker update handling\"), mdx(\"p\", null, \"The service worker updates automatically when the browser detects that the contents of the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"sw.js\"), \" file have changed from the currently installed version. Upon an update, we clear all whitelisted paths to prevent old pages from loading after the update.\"), mdx(\"p\", null, \"Blank pages can theoretically occur if we serve the app shell when resources are unavailable - however, this \", mdx(\"em\", {\n    parentName: \"p\"\n  }, \"should\"), \" never occur since we only serve the app shell with whitelisted paths (i.e. ones whose resources have been cached entirely). There may be some edge cases when this can occur, e.g. when the Webpack runtime from the old site attempts to load a chunk which is unavailable on the updated site - we are currently investigating ways to prevent this, and make using service workers with Gatsby even more robust.\"), mdx(\"p\", null, \"We should also never get incorrect 404 pages following a site update, since we never whitelist 404 pages to serve using the offline shell, meaning that a page which was previously a 404 should always load from the server. If it\\u2019s no longer a 404, then it will be cached as usual.\"));\n}\n;\nMDXContent.isMDXComponent = true;",
        "excerpt": "This document aims to outline how resources are fetched and cached by various parts of Gatsby. Offline Plugin (gatsby-plugin-offlineâ€¦",
        "timeToRead": 4,
        "tableOfContents": {
          "items": [
            {
              "url": "#offline-plugin-gatsby-plugin-offline",
              "title": "Offline Plugin (gatsby-plugin-offline)",
              "items": [
                {
                  "url": "#service-worker-swjs",
                  "title": "Service worker (sw.js)"
                },
                {
                  "url": "#browser-apis-gatsby-browserjs",
                  "title": "Browser APIs (gatsby-browser.js)"
                }
              ]
            },
            {
              "url": "#gatsby-core",
              "title": "Gatsby Core",
              "items": [
                {
                  "url": "#resource-loader-loaderjs",
                  "title": "Resource loader (loader.js)"
                },
                {
                  "url": "#ensureresources-ensure-resourcesjs",
                  "title": "EnsureResources (ensure-resources.js)"
                },
                {
                  "url": "#service-worker-update-handling",
                  "title": "Service worker update handling"
                }
              ]
            }
          ]
        },
        "fields": {
          "slug": "/docs/resource-handling-and-service-workers/",
          "anchor": "resource-handling-and-service-workers"
        },
        "frontmatter": {
          "title": "Resource Handling & Service Workers",
          "overview": null,
          "issue": null,
          "disableTableOfContents": null,
          "tableOfContentsDepth": null
        },
        "parent": {
          "__typename": "File",
          "relativePath": "docs/resource-handling-and-service-workers.md"
        }
      }
    },
    "pageContext": {
      "isCreatedByStatefulCreatePages": false,
      "slug": "/docs/resource-handling-and-service-workers/",
      "prev": {
        "title": "Code Splitting and Prefetching",
        "link": "/docs/how-code-splitting-works/"
      },
      "next": {
        "title": "Data Storage (Redux)*",
        "link": "/docs/data-storage-redux/"
      }
    }
  },
  "query": "query usersMisiekDevGatsbyWwwSrcTemplatesTemplateDocsMarkdownJs2546709735(\n  $path: String!\n) {\n  mdx(fields: {slug: {eq: $path}}) {\n    body\n    excerpt\n    timeToRead\n    tableOfContents\n    fields {\n      slug\n      anchor\n    }\n    frontmatter {\n      title\n      overview\n      issue\n      disableTableOfContents\n      tableOfContentsDepth\n    }\n    ...MarkdownPageFooterMdx\n  }\n}\n\nfragment MarkdownPageFooterMdx on Mdx {\n  parent {\n    __typename\n    ... on File {\n      relativePath\n    }\n  }\n}\n"
}